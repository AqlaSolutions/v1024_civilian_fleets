<?xml version="1.0" encoding="utf-8" ?>
<!-- 
Whenever a ship tries to obtain "first" orders...
1. Because it has just been freshly constructed (NOT OUR MAIN POINT)
2. Because it has just received a new assignment
Do:
1. Check if it is a ship-to-ship assignment (passively checked as a result of original code structure)
2. Check if it is being assigned to another ship running a recognized civilian command
3. If [2] returns true, syncs the civilian command from the commander to itself
4. If [2] returns true, also updates the wing name appropriately
-->
<diff>
    <add sel="/aiscript[@name='lib.request.orders']/attention/actions/do_else/do_else" pos="before">
        <!-- At this point, definitely assigning to another ship, no need to double-check. -->
        <!-- Check: trading fleet -->
        <do_elseif value="$assignment == assignment.trade">
            <set_value name="$isRunningAutoTrade" exact="$commander.defaultorder.id == 'TradeRoutine'"/>
            <do_if value="$isRunningAutoTrade">
                <set_value name="flag_v1024_civfleetformed" comment="Actual value not important." />
                <!-- Call standardized config script. -->
                <run_script name="'lib.civfleet.update.syncorders'">
                    <param name="fromShip" value="$commander" />
                    <param name="toShip" value="$object" />
                </run_script>
            </do_if>
        </do_elseif>
        <do_elseif value="$assignment == assignment.mining">
            <run_script name="'lib.civfleet.check.orderismining'" result="$isRunningAnyMiningRoutines">
                <param name="order" value="$commander.defaultorder" />
            </run_script>
            <do_if value="$isRunningAnyMiningRoutines">
                <set_value name="flag_v1024_civfleetformed" comment="Actual value not important." />
                <!-- Call standardized config script. -->
                <run_script name="'lib.civfleet.update.syncorders'">
                    <param name="fromShip" value="$commander" />
                    <param name="toShip" value="$object" />
                </run_script>
            </do_if>
        </do_elseif>
    </add>

    <!-- Rename wing if wing is civilian fleet -->
    <add sel="/aiscript[@name='lib.request.orders']/attention/actions/do_else/do_else" pos="after">
        <!-- Optimization: only attempt to rename fleet when we have actually formed any civ-fleets. -->
        <do_if value="$flag_v1024_civfleetformed?">
            <!-- Only the player can initiate illegal assignment as trader or miner. So we're pretty safe. -->
            <!-- Execute standardized fleet wing rename script. -->
            <run_script name="'lib.civfleet.update.wingname'">
                <param name="wingCommander" value="$commander"/>
            </run_script>
        </do_if>
    </add>
</diff>