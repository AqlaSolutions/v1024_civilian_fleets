<?xml version="1.0" encoding="utf-8" ?>
<mdscript name="V1024_CivilianFleets" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
  <cues>
    <cue name="VeryEarlyInit" version="2">
      <conditions>
        <check_any>
          <event_game_loaded/>
          <event_game_started/>
        </check_any>
      </conditions>
      <actions>
        <set_value name="global.$v1024_flags_hasRightClickAPI" exact="false" />
      </actions>
    </cue>
    <cue name="Register_CivilianFleets_RightClickMenu" version="2">
      <conditions>
        <event_cue_completed cue="md.Right_click_api.RegisterRight_click_api"/>
      </conditions>
      <delay exact="1s" comment="wait a sec if we have dependencies"/>
      <actions>
        <raise_lua_event name="'RegisterAddon'" param="'extensions.v1024_civilian_fleets.civilian_fleets'"/>
      </actions>
    </cue>
    <cue name="CivilianFleets_Feedback_Wanted" version="2">
      <conditions>
        <event_cue_completed cue="Register_CivilianFleets_RightClickMenu"/>
      </conditions>
      <actions>
        <reset_cue cue="Register_CivilianFleets_RightClickMenu"/>
        <reset_cue cue="CivilianFleets_Feedback_Wanted"/>

        <!-- Fallback system detection flag -->
        <set_value name="global.$v1024_flags_hasRightClickAPI" value="true" />
      </actions>
    </cue>
    <cue name="CivilianFleets_SettingUp" instantiate="true" version="2">
      <conditions>
        <event_cue_signalled cue="md.Setup.Start" />
      </conditions>
      <actions>
        <!-- Civilian Fleets fallback mode notifications -->
        <!--
        <show_help position="1" duration="6s" custom="global.$v1024_flags_hasRightClickAPI?"/>
        <show_help position="1" duration="6s" custom="global.$v1024_flags_hasRightClickAPI"/>
        -->
        <do_if value="not global.$v1024_flags_hasRightClickAPI">
          <!-- If the game is starting, but still no Right Click API detected: assume no such mod is loaded, and activate fallback mode.-->
          
          <show_help position="1" duration="6s" custom="'V1024-CF: Civilian Fleets failed to detect Right Click API. Fallback Mode engaged.'"/>
          <show_help position="1" duration="6s" custom="'V1024-CF: Use [(Default Role) Defend] to form/join civilian fleets instead.'"/>
          <show_help position="1" duration="6s" custom="'V1024-CF: Existing civilian fleets will still function normally.'"/>
          <show_help position="1" duration="6s" custom="'V1024-CF: Fallback Mode changes some rules about civilian fleet forming/joining:'"/>
          <show_help position="1" duration="6s" custom="'V1024-CF: Changed rule (1): Mining fleets can only accept ships with primary purpose = mine.'"/>
          <show_help position="1" duration="6s" custom="'V1024-CF: Changed rule (2): Trading fleets can only accept ships with primary purpose = trade.'"/>
          <show_help position="1" duration="6s" custom="'V1024-CF: This means, fight ships can no longer work for any civilian fleets.'"/>
          <show_help position="1" duration="6s" custom="'V1024-CF: Of course, fight ships already working for existing civilian fleets are not affeected.'"/>
          <show_help position="1" duration="6s" custom="'V1024-CF: This is the end of the Fallback Mode announcement.'"/>
        </do_if>
        <show_help position="1" duration="10s" custom="'Right click API flag set to: ' + global.$v1024_flags_hasRightClickAPI" chance="0"/>

        <!-- Safety -->
        <remove_value name="global.$civFleet_CmdTagPairs"/>

        <!-- Setting the value pairs -->
        <set_value name="global.$civFleet_CmdTagPairs" exact="[]" />

        <!-- Hardcoded inputting -->
        <!-- Vanilla value-pairs -->
        <!-- Trading Fleet -->
        <append_to_list name="global.$civFleet_CmdTagPairs" exact="['TradeRoutine', {221024, 1001}]" />
        <!-- Mining Fleet(s) -->
        <append_to_list name="global.$civFleet_CmdTagPairs" exact="['MiningRoutine', {221024, 2001}]" />
        <append_to_list name="global.$civFleet_CmdTagPairs" exact="['MiningRoutine_Basic', {221024, 2001}]" />
        <append_to_list name="global.$civFleet_CmdTagPairs" exact="['MiningRoutine_Advanced', {221024, 2001}]" />
        <append_to_list name="global.$civFleet_CmdTagPairs" exact="['MiningRoutine_Expert', {221024, 2001}]" />
        <!-- Distribution Fleet -->
        <append_to_list name="global.$civFleet_CmdTagPairs" exact="['Middleman', {221024, 1002}]" />

        <!-- Mod value-pairs -->
        <!-- TaterTrade Fleet -->
        <append_to_list name="global.$civFleet_CmdTagPairs" exact="['TaterTrade', {221024, 1101}]" />

        <!-- Mules and Warehouses Fleets -->
        <append_to_list name="global.$civFleet_CmdTagPairs" exact="['DistriMule', {221024, 1201}]" />
        <append_to_list name="global.$civFleet_CmdTagPairs" exact="['StationMule', {221024, 1202}]" />
        <append_to_list name="global.$civFleet_CmdTagPairs" exact="['TravelMule', {221024, 1203}]" />

        <!-- To make sub-mods for this mod, simply append to the above list after this cue is complete. -->
      </actions>
    </cue>
  </cues>
</mdscript>